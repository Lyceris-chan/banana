name: Build Custom Alpine ISO

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest
    container:
      image: alpine:edge
    steps:
      - name: Set up build environment
        run: |
          apk update
          apk add alpine-sdk alpine-conf syslinux xorriso squashfs-tools grub grub-efi doas mtools dosfstools

          # Add user 'build' and set permissions
          adduser -D build
          addgroup build abuild
          echo "permit :abuild" > /etc/doas.d/doas.conf
          echo "permit persist :abuild" >> /etc/doas.d/doas.conf

          # Switch to the 'build' user
          su - build

      - name: Clone Alpine aports repository
        run: |
          git clone --depth=1 https://gitlab.alpinelinux.org/alpine/aports.git

      - name: Create mkimg.profile script for custom ISO
        run: |
          # In the name of glue if this works istg
          # should fix: /__w/_temp/e02b137a-16db-4ffe-b68e-02373f183974.sh: line 2: can't create /github/home/aports/scripts/mkimg.custom.sh: nonexistent directory
          # mkdir -p ~/aports/scripts
          export PROFILENAME=custom
          cat << EOF > ~/aports/scripts/mkimg.$PROFILENAME.sh
          profile_$PROFILENAME() {
              profile_standard
              kernel_cmdline="unionfs_size=512M console=tty0 console=ttyS0,115200"
              syslinux_serial="0 115200"
              apks="\$apks upower"

              # Additional packages for upower
              apks="\$apks linux-firmware"

              local _k _a
              for _k in \$kernel_flavors; do
                  apks="\$apks linux-\$_k"
              done
          }
          EOF

      - name: Add upower to live system via genapkovl script
        run: |
          cp ~/aports/scripts/genapkovl-dhcp.sh ~/aports/scripts/genapkovl-mkimgoverlay.sh
          sed -i '/makefile root:root 0644/a\\nupower\n' ~/aports/scripts/genapkovl-mkimgoverlay.sh
          echo "apkovl=\"aports/scripts/genapkovl-mkimgoverlay.sh\"" >> ~/aports/scripts/mkimg.$PROFILENAME.sh

      - name: Create custom script for battery check
        run: |
          cat << 'EOF' > ~/battery_check.sh
          #!/bin/sh
          echo "Battery Information:"
          upower -i $(upower -e | grep battery) | grep -E "state|to\ full|percentage|capacity"

          # Check if the battery's capacity is above or below 80%
          capacity=$(upower -i $(upower -e | grep battery) | grep -oP "(?<=capacity:\s)\d+")
          if [ "\$capacity" -ge 80 ]; then
              echo "=================="
              echo "       PASS        "
              echo "=================="
          else
              echo "=================="
              echo "       FAIL        "
              echo "=================="
          fi
          EOF

          chmod +x ~/battery_check.sh
          echo "battery_check.sh" >> ~/aports/scripts/mkimg.$PROFILENAME.sh

      - name: Build the custom Alpine ISO
        run: |
          mkdir -p ~/iso
          sh ~/aports/scripts/mkimage.sh --tag edge --outdir ~/iso --arch x86_64 \
            --repository https://dl-cdn.alpinelinux.org/alpine/edge/main \
            --profile custom

      - name: Upload ISO as artifact
        uses: actions/upload-artifact@v3
        with:
          name: custom-alpine-iso
          path: ~/iso/*.iso
