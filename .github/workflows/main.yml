name: Build Custom Alpine ISO

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest
    container:
      image: alpine:edge
    steps:
      - name: Set up cache for APK packages
        uses: actions/cache@v3
        with:
          path: /var/cache/apk
          key: ${{ runner.os }}-apk-cache
          restore-keys: |
            ${{ runner.os }}-apk-cache

      - name: Set up build environment
        run: |
          apk update
          apk add alpine-sdk alpine-conf syslinux xorriso squashfs-tools grub grub-efi doas mtools dosfstools

          # Add user 'build' and configure permissions
          adduser -D build
          addgroup build abuild
          echo "permit :abuild" > /etc/doas.d/doas.conf
          echo "permit persist :abuild" >> /etc/doas.d/doas.conf

      - name: Cache aports repository
        uses: actions/cache@v3
        with:
          path: ~/aports
          key: ${{ runner.os }}-aports-cache
          restore-keys: |
            ${{ runner.os }}-aports-cache

      - name: Clone Alpine aports repository (if cache miss)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 https://gitlab.alpinelinux.org/alpine/aports.git ~/aports

      - name: Create mkimg profile for custom ISO
        run: |
          mkdir -p ~/aports/scripts
          export PROFILENAME=custom
          cat << 'EOF' > ~/aports/scripts/mkimg.$PROFILENAME.sh
          profile_$PROFILENAME() {
              profile_standard
              kernel_cmdline="unionfs_size=512M console=tty0 console=ttyS0,115200"
              syslinux_serial="0 115200"
              apks="\$apks upower linux-firmware"

              local _k
              for _k in \$kernel_flavors; do
                  apks="\$apks linux-\$_k"
              done
          }
          EOF

      - name: Modify genapkovl script to add upower
        run: |
          cp ~/aports/scripts/genapkovl-dhcp.sh ~/aports/scripts/genapkovl-mkimgoverlay.sh
          sed -i '/makefile root:root 0644/a\\nupower\n' ~/aports/scripts/genapkovl-mkimgoverlay.sh
          echo "apkovl=\"aports/scripts/genapkovl-mkimgoverlay.sh\"" >> ~/aports/scripts/mkimg.$PROFILENAME.sh

      - name: Create custom battery check script
        run: |
          cat << 'EOF' > ~/aports/scripts/battery_check.sh
          #!/bin/sh
          echo "Battery Information:"
          upower -i $(upower -e | grep battery) | grep -E "state|to full|percentage|capacity"

          # Check if the battery's capacity is above or below 80%
          capacity=$(upower -i $(upower -e | grep battery) | grep -oP "(?<=capacity:\s)\d+")
          if [ "\$capacity" -ge 80 ]; then
              echo "=================="
              echo "       PASS        "
              echo "=================="
          else
              echo "=================="
              echo "       FAIL        "
              echo "=================="
          fi
          EOF

          chmod +x ~/aports/scripts/battery_check.sh

      - name: Add battery check script to profile
        run: |
          # Copy battery check script to the custom overlay for the live ISO
          echo "battery_check.sh" >> ~/aports/scripts/mkimg.$PROFILENAME.sh
          echo "install -Dm755 ~/aports/scripts/battery_check.sh \$DESTDIR/root/battery_check.sh" >> ~/aports/scripts/mkimg.$PROFILENAME.sh

      - name: Build the custom Alpine ISO
        run: |
          mkdir -p ~/iso
          sh ~/aports/scripts/mkimage.sh --tag edge --outdir ~/iso --arch x86_64 \
            --repository https://dl-cdn.alpinelinux.org/alpine/edge/main \
            --profile custom

      - name: Upload ISO as artifact
        uses: actions/upload-artifact@v3
        with:
          name: custom-alpine-iso
          path: ~/iso/*.iso
